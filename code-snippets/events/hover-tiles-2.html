<!-- 
  SSA Events Widget v2 - Squarespace Code Injection
  
  This widget fetches events from a Supabase database and displays them as a responsive grid of cards.
  This is an alternative version of the events widget with the same functionality as event-list.html.
  
  Features:
  - Fetches upcoming events from the 'events' table
  - Displays events in a responsive grid (1-3 columns based on screen size)
  - Shows event name, date range, location, recurrence, and website links
  - Includes caching for better performance
  - Handles loading states with skeleton animations
  - Automatically filters to show only upcoming/ongoing events
  - Includes shimmer loading animation
  
  Usage: Include this code in Squarespace Code Injection and it will render events in the #events-list div
-->

<!-- 1) One-time: widget script -->
<script>
    (() => {
      function todayISO() { const d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
    
      async function fetchEvents({ url, key, from = todayISO(), to = null, limit = 200 }) {
          const api = new URL(url + '/rest/v1/events');
          api.searchParams.set('select','name,slug,host_org,start_date,end_date,location,website_url,recurrence,sort_order');
          api.searchParams.set('order','start_date.asc,name.asc');
          api.searchParams.set('limit', String(limit));
    
          // Show upcoming events if FROM is set.
          // Include rows where:
          //  - end_date >= from  OR
          //  - start_date >= from  OR
          //  - both dates are null (undated events)
          if (from) {
            // IMPORTANT: wrap conditions in parentheses
            const orFilter =
              `(end_date.gte.${from},start_date.gte.${from},and(start_date.is.null,end_date.is.null))`;
            api.searchParams.set('or', orFilter);
          }
          if (to) {
            api.searchParams.set('start_date', `lte.${to}`);
          }
          
          console.debug('Events API URL:', api.toString());
    
          const res = await fetch(api, { headers: { apikey: key, Authorization: 'Bearer ' + key, Accept: 'application/json' }});
          if (!res.ok) throw new Error('Fetch failed: ' + res.status);
          return res.json();
        }
    
      function fmtRange(s, e){
        if (!s && !e) return '';
        if (s && !e) return s;
        if (!s && e) return e;
        return s === e ? s : `${s} – ${e}`;
      }
    
      function renderEvents(mount, rows) {
        const cards = rows.map(ev => `
          <article class="ssa-card">
            <header class="ssa-card-head"><h3 class="ssa-title">${ev.name}</h3></header>
            <p class="ssa-meta">${fmtRange(ev.start_date, ev.end_date)}${ev.location ? ' · ' + ev.location : ''}</p>
            ${ev.recurrence ? `<p class="ssa-meta">${ev.recurrence}</p>` : ''}
            ${ev.website_url ? `<p class="ssa-actions"><a class="ssa-link" href="${ev.website_url}" target="_blank" rel="noopener">Details</a></p>` : ''}
          </article>
        `).join('');
        mount.innerHTML = `<div class="ssa-grid">${cards || '<div class="ssa-empty">No upcoming events.</div>'}</div>`;
        if (!document.getElementById('ssa-styles-events')) {
          const css = document.createElement('style');
          css.id = 'ssa-styles-events';
          css.textContent = `
            .ssa-grid{display:grid;gap:16px}
            @media(min-width:720px){.ssa-grid{grid-template-columns:repeat(2,1fr)}}
            @media(min-width:1024px){.ssa-grid{grid-template-columns:repeat(3,1fr)}}
            .ssa-card{border:1px solid #e5e7eb;border-radius:14px;padding:14px;background:#fff}
            .ssa-title{margin:0;font-size:1.05rem;line-height:1.3}
            .ssa-meta{margin:.35rem 0;color:#6b7280}
            .ssa-link{text-decoration:underline}
            .ssa-empty{color:#6b7280}
            .ssa-skel{height:110px;border-radius:14px;background:linear-gradient(90deg,#f4f4f5,#f9fafb,#f4f4f5);background-size:200% 100%;animation:ssaShimmer 1.1s linear infinite}
            @keyframes ssaShimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
          `;
          document.head.appendChild(css);
        }
      }
    
      async function renderEventsWidget(opts) {
        const mount = document.querySelector(opts.mount);
        if (!mount) return;
        mount.innerHTML = `<div class="ssa-grid"><div class="ssa-skel"></div><div class="ssa-skel"></div><div class="ssa-skel"></div></div>`;
        try {
          const key = `ssa_events:${opts.url}:${opts.from||'today'}:${opts.to||''}:${opts.limit||200}`;
          const cached = sessionStorage.getItem(key);
          if (cached) renderEvents(mount, JSON.parse(cached));
          const rows = await fetchEvents(opts);
          sessionStorage.setItem(key, JSON.stringify(rows));
          renderEvents(mount, rows);
        } catch (e) {
          console.error(e);
          mount.innerHTML = `<div class="ssa-empty">Sorry, events are unavailable right now.</div>`;
        }
      }
    
      window.SSWidgets = window.SSWidgets || {};
      window.SSWidgets.renderEvents = renderEventsWidget;
    })();
    </script>
    
    <!-- 2) Mount + init call -->
    <div id="events-list"></div>
    <script>
      SSWidgets.renderEvents({
        mount: '#events-list',
        url: 'https://ydftcebaftngcdjvxrgl.supabase.co',
        key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkZnRjZWJhZnRuZ2NkanZ4cmdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDA5NDcsImV4cCI6MjA3NjExNjk0N30.8AlcsUMJSxBlua-ehaGLAn69bbORoMBdjM--MSxxXF0',
        //from: undefined,   // default = today (only ongoing/upcoming)
        //to: undefined,     // set like '2025-12-31' to cap the range if you want
        limit: 200
      });
    </script>