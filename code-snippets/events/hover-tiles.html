<!-- 
  SSA Events List Widget - Squarespace Code Injection
  
  This widget fetches events from a Supabase database and displays them as a list grouped by month.
  This is the list format version (as opposed to the card grid format in other widgets).
  
  Features:
  - Fetches events from the 'events' table and groups them by month
  - Displays events in a chronological list format with month headers
  - Shows event names as clickable links (external URLs or internal slugs)
  - Includes event location, host organization, and date information
  - Responsive design with clean typography
  - Handles loading states and error conditions
  - Automatically filters to show only published events
  
  Usage: Include this code in Squarespace Code Injection and it will render events in the #events-list div
-->

<section class="events-wireframe">
  <h2>Fiddletown Area Signature Events</h2>
  <div id="events-list" class="events-list">
    <!-- Events will be loaded here -->
  </div>
</section>

<!-- Load Supabase client library -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// Supabase configuration - replace with your actual values
const SUPABASE_URL = 'https://ydftcebaftngcdjvxrgl.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkZnRjZWJhZnRuZ2NkanZ4cmdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDA5NDcsImV4cCI6MjA3NjExNjk0N30.8AlcsUMJSxBlua-ehaGLAn69bbORoMBdjM--MSxxXF0';

// Initialize Supabase client
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Function to format date for display
function formatEventDate(dateString) {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { 
    month: 'long', 
    day: 'numeric' 
  });
}

// Function to get month name from date
function getMonthName(dateString) {
  if (!dateString) return 'TBA';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { month: 'long' });
}

// Function to group events by month
function groupEventsByMonth(events) {
  const grouped = {};
  
  events.forEach(event => {
    const month = getMonthName(event.start_date);
    if (!grouped[month]) {
      grouped[month] = [];
    }
    grouped[month].push(event);
  });
  
  return grouped;
}

// Function to render events
async function renderEvents() {
  try {
    const { data: events, error } = await supabaseClient
      .from('events')
      .select('name, slug, start_date, end_date, location, host_org, website_url, status')
      .eq('status', 'published')
      .order('start_date', { ascending: true });

    if (error) {
      console.error('Error fetching events:', error);
      document.getElementById('events-list').innerHTML = '<p>Error loading events. Please try again later.</p>';
      return;
    }

    if (!events || events.length === 0) {
      document.getElementById('events-list').innerHTML = '<p>No events scheduled at this time.</p>';
      return;
    }

    const groupedEvents = groupEventsByMonth(events);
    const months = Object.keys(groupedEvents).sort((a, b) => {
      const monthOrder = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
      return monthOrder.indexOf(a) - monthOrder.indexOf(b);
    });

    let html = '';
    
    months.forEach(month => {
      html += `<div class="month-group">`;
      html += `<h3 class="month-header">${month}</h3>`;
      html += `<ul class="events-month-list">`;
      
      groupedEvents[month].forEach(event => {
        const startDate = formatEventDate(event.start_date);
        const endDate = event.end_date ? formatEventDate(event.end_date) : '';
        const dateRange = endDate && startDate !== endDate ? `${startDate} - ${endDate}` : startDate;
        
        html += `<li class="event-item">`;
        
        // Create event link - use website_url if available, otherwise create a slug-based URL
        let eventUrl = '#';
        if (event.website_url) {
          eventUrl = event.website_url;
        } else if (event.slug) {
          eventUrl = `/events/${event.slug}`;
        } else {
          // Create a URL-friendly slug from the event name
          const slug = event.name.toLowerCase()
            .replace(/[^a-z0-9\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .trim('-');
          eventUrl = `/events/${slug}`;
        }
        
        html += `<a href="${eventUrl}" class="event-link" target="_blank" rel="noopener noreferrer">`;
        html += `<strong>${event.name}</strong>`;
        html += `</a>`;
        
        if (event.location) {
          html += ` <strong>(${event.location})</strong>`;
        }
        if (event.host_org) {
          html += ` – ${event.host_org}`;
        }
        if (dateRange) {
          html += ` – ${dateRange}`;
        }
        html += `</li>`;
      });
      
      html += `</ul></div>`;
    });

    document.getElementById('events-list').innerHTML = html;
  } catch (error) {
    console.error('Error:', error);
    document.getElementById('events-list').innerHTML = '<p>Error loading events. Please try again later.</p>';
  }
}

// Load events when the page loads
document.addEventListener('DOMContentLoaded', renderEvents);
</script>
<style>
.events-wireframe { 
  padding: 1rem 0 2rem; 
  max-width: 800px;
  margin: 0 auto;
}

.events-wireframe h2 {
  font-size: clamp(1.5rem, 2vw, 2rem);
  margin-bottom: 1.5rem;
  text-align: center;
}

.events-list {
  font-family: Georgia, serif;
}

.month-group {
  margin-bottom: 2rem;
}

.month-header {
  font-size: 1.5rem;
  font-weight: bold;
  margin-bottom: 0.75rem;
  color: #2c3e50;
  border-bottom: 2px solid #e8d5b7;
  padding-bottom: 0.25rem;
}

.events-month-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.event-item {
  margin-bottom: 0.75rem;
  line-height: 1.4;
  font-size: 1rem;
}

.event-item strong {
  color: #2c3e50;
}

.event-link {
  color: #2c3e50;
  text-decoration: none;
  border-bottom: 1px solid transparent;
  transition: border-bottom-color 0.2s ease;
}

.event-link:hover {
  border-bottom-color: #2c3e50;
  text-decoration: none;
}

.event-link strong {
  color: inherit;
}

.event-item:last-child {
  margin-bottom: 0;
}

/* Loading and error states */
.events-list p {
  text-align: center;
  color: #666;
  font-style: italic;
  padding: 2rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .events-wireframe {
    padding: 0.5rem 1rem 1.5rem;
  }
  
  .month-header {
    font-size: 1.25rem;
  }
  
  .event-item {
    font-size: 0.9rem;
  }
}
</style>